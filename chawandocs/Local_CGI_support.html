<!DOCTYPE html>
<!-- saved from url=(0040)https://chawan.net/doc/cha/localcgi.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>
Chawan: Local CGI support in Chawan
</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="shortcut icon" href="https://chawan.net/favicon.ico">
<style>
    /* layout */
*           { box-sizing: border-box; border-width: 0 }
body            { display: flex; flex-direction: column }
body            { min-height: 100vh; margin: 0 auto }
header          { max-width: 60ch; display: flex; flex-wrap: wrap }
header a        { display: block; flex: 1; font-size: larger }
main            { width: 72ch; margin: 1em auto }
@media(width<72ch){main { width: 100% }                        }
footer          { float: right; font-style: italic }
main            { display: flow-root; padding: 0 1ch }
h1, h2, h3, h4, h5, h6  { font-size: inherit }
table           { border-spacing: .5ch 0; margin: 0 -1ch }
figure, img     { max-width: 100%; margin: 0 }
figure          { padding: 1em 0 0 0 }
figcaption      { text-align: center }
pre         { padding-left: 1ch }
@media(grid:0){ h1  { padding: 1ch 0 0; margin: 0 }
        td, th  { padding: .3ch 1ch }
    code, pre   { font-size: 15px }     }
    /* colors */
*           { color: white }
header a        { background: #204A50 }
header a.current    { background: #192C30 }
header a:hover      { background: #192930 }
body            { background: #102527 }
main            { background: #103C40 }
main a[href]        { color: #FFC6CB }
th, td          { background: #113134 }
tr:nth-child(2n) > *    { background: #102628 }
    /* decoration */
a[href]         { text-decoration: none }
a[href]:hover       { text-decoration: underline }
header a[href]:hover    { text-decoration: none }
</style>
</head>
<body>
<center>
<header>
<a href="https://chawan.net/index.html">Index</a> <a href="https://chawan.net/news/index.html">News</a> <a href="https://chawan.net/doc/index.html">Docs</a> <a href="https://chawan.net/issues.html">Issues</a> <a href="https://sr.ht/~bptato/chawan">Source</a>
</header>
</center>
<main>
<!-- MANON
% cha-localcgi(5) | Local CGI support in Chawan
MANOFF -->
<h1 id="local-cgi-support-in-chawan">Local CGI support in Chawan</h1>
<p>Chawan supports the invocation of CGI scripts locally. This feature
can be used in the following way:</p>
<ul>
<li>All local CGI scripts must be placed in a directory specified in
<code>external.cgi-dir</code>. Multiple directories can be specified in
an array too, and directories specified first have higher
precedence.<br>
By default, this is set to <code>$CHA_DIR/cgi-bin</code> (i.e.
<code>~/.chawan/cgi-bin</code> or <code>~/.config/chawan/cgi-bin</code>,
depending on <code>config.toml</code>’s location) and
<code>/usr/local/libexec/chawan/cgi-bin</code>.</li>
<li>Then, a CGI script in one of these directories can be executed by
visiting the URL <code>cgi-bin:script-name</code>. $PATH_INFO and
$QUERY_STRING are set as normal,
i.e.&nbsp;<code>cgi-bin:script-name/abcd?defgh=ijkl</code> will set
$PATH_INFO to <code>/abcd</code>, and $QUERY_STRING to
<code>defgh=ijkl</code>.</li>
</ul>
<p>Further notes on processing CGI paths:</p>
<ul>
<li>The URL must be opaque, so you must not add a double slash after the
scheme. e.g.&nbsp;<code>cgi-bin://script-name</code> will NOT work, only
<code>cgi-bin:script-name</code>.</li>
<li>Paths beginning with <code>/cgi-bin/</code> or <code>/$LIB/</code>
are stripped of this segment automatically. So
e.g.&nbsp;<code>cgi-bin:/cgi-bin/script-name</code> becomes
<code>cgi-bin:script-name</code>.</li>
<li>If <code>external.w3m-cgi-compat</code> is true, file: URLs are
converted to cgi-bin: URLs if the path name starts with
<code>/cgi-bin/</code>, <code>/$LIB/</code>, or the path of a local CGI
script. Note: this is unsafe, please do not use it unless you must.</li>
<li>Absolute paths are accepted as
e.g.&nbsp;<code>cgi-bin:/path/to/cgi/dir/script-name</code>. Note however,
that this only works if <code>/path/to/cgi/dir</code> has already been
specified as a CGI directory in <code>external.cgi-dir</code>.</li>
</ul>
<p>Note that this is different from w3m’s cgi-bin functionality, in that
we use a custom scheme for local CGI instead of interpreting all
requests to a designated path as a CGI request. (This incompatibility is
bridged over when <code>external.w3m-cgi-compat</code> is true.)</p>
<h2 id="headers">Headers</h2>
<p>Local CGI scripts may send some headers that Chawan will interpret
specially (and thus will not pass forward to e.g.&nbsp;the fetch API,
etc):</p>
<ul>
<li><code>Status</code>: interpreted as the HTTP status code.</li>
<li><code>Cha-Control</code>: special header, see below.</li>
</ul>
<p>Note that these headers MUST be sent before any regular headers.
Headers received after a regular header or a
<code>Cha-Control: ControlDone</code> header will be treated as regular
headers.</p>
<p>The <code>Cha-Control</code> header’s value is parsed as follows:</p>
<pre><code>Cha-Control-Value = Command *Parameter
Command = ALPHA *ALPHA
Parameter = SPACE *CHAR</code></pre>
<p>In other words, it is <code>Command [Param1] [Param2] ...</code>.</p>
<p>Currently available commands are:</p>
<ul>
<li><code>Connected</code>: Takes no parameters. Must be the first
reported header; it means that connection to the server has been
successfully established, but no data has been received yet. When any
other header is sent first, Chawan will act as if a
<code>Cha-Control: Connected</code> header had been implicitly sent
before that.</li>
<li><code>ConnectionError</code>: Must be the first reported header.
Parameter 1 is the error code, see below. If any following parameters
are given, they are concatenated to form a custom error message.<br>
Note: short but descriptive error messages are preferred, messages that
do not fit on the screen are currently truncated. (TODO fix this somehow
:P)</li>
<li><code>ControlDone</code>: Signals that no more special headers will
be sent; this means that <code>Cha-Control</code> and
<code>Status</code> headers sent after this must be interpreted as
regular headers (and thus e.g.&nbsp;will be available for JS code calling the
script using the fetch API).<br>
WARNING: this header must be sent before any non-hardcoded headers that
take external input. For example, an HTTP client would have to send
<code>Cha-Control: ControlDone</code> before returning the retrieved
headers.</li>
</ul>
<p>Following is a list of error codes and their string counterparts. CGI
scripts may use either (but not both) in a ConnectionError header.</p>
<ul>
<li><code>1 InternalError</code>: An internal error prevented the script
from retrieving the requested resource. CGI scripts can also use this to
signal that they have no information on what went wrong.</li>
<li><code>2 InvalidMethod</code>: The client requested data using a
method not supported by this protocol.</li>
<li><code>3 InvalidURL</code>: The request URL could not be interpreted
as a valid URL for this format.</li>
<li><code>4 FileNotFound</code>: No file was found at the requested
address, and thus the request is meaningless. Note: this should only be
used by protocols that do not rely on a client-server architecture,
e.g.&nbsp;local file access, local databases, or peer-to-peer file retrieval
mechanisms. A server responding with “no file found” is NOT a connection
error, and is better represented as a response with a 404 status
code.</li>
<li><code>5 FailedToResolveHost</code>: The hostname could not be
resolved.</li>
<li><code>6 FailedToResolveProxy</code>: The proxy could not be
resolved.</li>
<li><code>7 ConnectionRefused</code>: The server refused to establish a
connection.</li>
<li><code>8 ProxyRefusedToConnect</code>: The proxy refused to establish
a connection.</li>
</ul>
<h2 id="environment-variables">Environment variables</h2>
<p>Chawan sets the following environment variables:</p>
<ul>
<li><code>SERVER_SOFTWARE="Chawan"</code></li>
<li><code>SERVER_PROTOCOL="HTTP/1.0"</code></li>
<li><code>SERVER_NAME="localhost"</code></li>
<li><code>SERVER_PORT="80"</code></li>
<li><code>REMOTE_HOST="localhost"</code></li>
<li><code>REMOTE_ADDR="127.0.0.1"</code></li>
<li><code>GATEWAY_INTERFACE="CGI/1.1"</code></li>
<li><code>SCRIPT_NAME="/cgi-bin/script-name"</code> if called with a
relative path, and <code>"/path/to/script/script-name"</code> if called
with an absolute path.</li>
<li><code>SCRIPT_FILENAME="/path/to/script/script-name"</code></li>
<li><code>QUERY_STRING=</code> the query string
(i.e.&nbsp;<code>URL.search</code>). Note that this variable is
percent-encoded.</li>
<li><code>PATH_INFO=</code> everything after the script’s path name,
e.g.&nbsp;for <code>cgi-bin:script-name/abcd/efgh</code>
<code>"/abcd/efgh"</code>. Note that this variable is NOT
percent-encoded.</li>
<li><code>REQUEST_URI="$SCRIPT_NAME/$PATH_INFO?$QUERY_STRING</code></li>
<li><code>REQUEST_METHOD=</code> HTTP method used for making the
request, e.g.&nbsp;GET or POST</li>
<li><code>REQUEST_HEADERS=</code> A newline-separated list of all
headers for this request.</li>
<li><code>CHA_LIBEXEC_DIR=</code> The libexec directory Chawan was
configured to use at compile time. See the <a href="https://chawan.net/doc/cha/localcgi.html#tools">tools</a>
section below for details of why this is useful.</li>
<li><code>CONTENT_TYPE=</code> for POST requests, the Content-Type
header. Not set for other request types (e.g.&nbsp;GET).</li>
<li><code>CONTENT_LENGTH=</code> the content length, if $CONTENT_TYPE
has been set.</li>
<li><code>ALL_PROXY=</code> if a proxy has been set, the proxy URL.
WARNING: for security reasons, this MUST be respected when making
external connections. If a CGI script does not support proxies, it must
never make any external connections when the <code>ALL_PROXY</code>
variable is set, even if this results in it returning an error.</li>
<li><code>HTTP_COOKIE=</code> if set, the Cookie header.</li>
<li><code>HTTP_REFERER=</code> if set, the Referer header.</li>
<li><code>CHA_TMP_DIR=</code> directory used for storing temporary
files.</li>
<li><code>CHA_DIR=</code> location of the config file.</li>
</ul>
<p>For requests originating from a urimethodmap rewrite, Chawan will
also set the parsed URL’s parts as environment variables. Use of these
is highly encouraged, to avoid exploits originating from double-parsing
of URLs.</p>
<p>e.g.&nbsp;if
example://username:password@example.org:1234/path/name.html?example is
the original URL, then:</p>
<ul>
<li><code>MAPPED_URI_SCHEME=</code> the scheme of the original URL, in
this case <code>example</code>.</li>
<li><code>MAPPED_URI_USERNAME=</code> the username part, in this case
<code>username</code>. If no username was specified, the variable is set
to the empty string.</li>
<li><code>MAPPED_URI_PASSWORD=</code> the password part, in this case
<code>password</code>. If no password was specified, the variable is set
to the empty string.</li>
<li><code>MAPPED_URI_HOST=</code> the host part, in this case
<code>host.org</code> If no host was specified, the variable is set to
the empty string. (An example of a URL with no host:
<code>about:blank</code>, here <code>blank</code> is the path
name.)</li>
<li><code>MAPPED_URI_PORT=</code> the port, in this case
<code>1234</code>. If no port was specified, the variable is set to the
empty string. (In this case, the CGI script is expected to use the
default port for the scheme, if any.)</li>
<li><code>MAPPED_URI_PATH=</code> the path name, in this case
<code>/path/name.html?example</code>. If no path was specified, the
variable is set to the empty string. Note: the path name is
percent-encoded.</li>
<li><code>MAPPED_URI_QUERY=</code> the query string, in this case
<code>example</code>. Note that, unlike in JavaScript, no question mark
is prepended to the string.<br>
The query string is percent-encoded as well.</li>
</ul>
<p>Note: the fragment part is omitted intentionally.</p>
<h2 id="request-body">Request body</h2>
<p>If the request body is not empty, it is streamed into the program
through the standard input.</p>
<p>Note that this may be both an application/x-www-form-urlencoded or a
multipart/form-data request; <code>CONTENT_TYPE</code> stores
information about the request type, and in case of a multipart request,
the boundary as well.</p>
<h2 id="tools">Tools</h2>
<p>Chawan provides certain helper binaries that may be useful for CGI
scripts. These can be portably accessed by executing
<code>"$CHA_LIBEXEC_DIR"/[program name]</code>.</p>
<p>Currently, the following tools are available:</p>
<ul>
<li><code>urldec</code>: percent-decode strings passed on standard
input.</li>
<li><code>urlenc</code>: percent-encode strings passed on standard
input, taking a percent-encode set as the first parameter.</li>
</ul>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>Note that standard error is redirected to the browser console (by
default, M-cM-c). This makes it easy to debug a misbehaving CGI script,
but may also slow down the browser in case of excessive logging. If this
is not the desired behavior, we recommend wrapping your script into a
shell script that redirects stderr to /dev/null.</p>
<h3 id="my-script-is-returning-a-failed-to-execute-script-error-message.">My
script is returning a “Failed to execute script” error message.</h3>
<p>This means the <code>execl</code> call to the script failed. Make
sure that your CGI script’s executable bit is set, i.e.&nbsp;run
<code>chmod +x /path/to/cgi/script</code>.</p>
<h3 id="my-script-is-returning-an-invalid-cgi-path-error-message.">My
script is returning an “invalid CGI path” error message.</h3>
<p>Make sure that you did not include leading slashes. Reminder:
<code>cgi-bin://script-name</code> does not work, use
<code>cgi-bin:script-name</code>.</p>
<h3 id="my-script-is-returning-a-cgi-file-not-found-error-message.">My
script is returning a “CGI file not found” error message.</h3>
<p>Double check that your CGI script is in the correct location. Also,
make sure that you are not accidentally calling the script with an
absolute path via <code>cgi-bin:/script-name</code> (instead of the
correct <code>cgi-bin:script-name</code>).</p>
<p>It is also possible that <code>external.cgi-dir</code> is not really
set to the directory your script is in. Note that by default, this
depends on the binary’s path, so e.g.&nbsp;if your binary is in
<code>~/src/chawan/target/release/bin/cha</code>, but you put your CGI
script to <code>/usr/local/libexec/chawan/cgi-bin</code>, then it will
not work.</p>
<h3 id="my-script-is-returning-a-failed-to-set-up-cgi-script-error-message.">My
script is returning a “failed to set up CGI script” error message.</h3>
<p>This means that either <code>pipe</code> or <code>fork</code> failed.
Something strange is going on with your system; we recommend exorcism.
(Maybe you are running out of memory?)</p>
<!-- MANON
## See also

**cha**(1) **cha-urimethodmap**(5)
MANOFF -->
</main>
</body></html>